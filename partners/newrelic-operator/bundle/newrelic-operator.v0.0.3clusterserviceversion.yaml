apiVersion: operators.coreos.com/v1alpha1
kind: ClusterServiceVersion
metadata:
  annotations:
    alm-examples: |-
      [{
       "apiVersion": "apm.newrelic.com/v1alpha1",
       "kind": "NewRelic",
       "metadata": {
          "name": "example-newrelic"
       },
       "spec": {
          "image": {
             "name": "registry.connect.redhat.com/newrelic-openshift/newrelic-infrastructure-k8s-1",
             "tag": "latest",
             "pullPolicy": "IfNotPresent"
          },
          "newrelic": {
             "zone": "k8s-cluster-name",
             "leaderElectorPort": 42655,
             "agent": {
                "key": "YOUR-KEY-GOES-HERE",
                "name": "newrelic-agent",
                "endpoint": {
                   "host": "saas-us-west-2.newrelic.io",
                   "port": 443
                }
             }
          },
          "podAnnotations": {},
          "serviceAccount": "newrelic-agent",
          "tolerations": [],
          "computeResources": {
             "requests": {
                "memory": 512,
                "cpu": 0.5
             },
             "limits": {
                "memory": 512,
                "cpu": 1.5
             }
          }
       }
      }]
    categories: "Monitoring,OpenShift Optional"
    capabilities: "Basic Install"
    certified: "false"
    containerImage: quay.io/rhc4tp/newrelic-operator:v0.0.3
    createdAt: 2019-04-18T12:59:59Z
    description: Deploy the NewRelic agent from a helm chart onto your Kubernetes or OpenShift cluster
    repository: https://github.com/RHC4TP/operators/tree/master/partners/newrelic-operator
    support: Red Hat Connect
  name: newrelic-operator.v0.0.3
  namespace: "placeholder"
spec:
  apiservicedefinitions: {}
  customresourcedefinitions:
    owned:
      - description: NewRelic Operator by Red Hat Partner Connect
        displayName: NewRelic Operator
        kind: NewRelic
        name: newrelics.apm.newrelic.com
        resources:
          - kind: DaemonSet
            name: ""
            version: apps/v1
          - kind: Pod
            name: ""
            version: v1
          - kind: Secret
            name: ""
            version: v1
          - kind: ConfigMap
            name: ""
            version: v1
        specDescriptors:
          - description: NewRelic agent container image name
            displayName: Image Name
            path: image.name
          - description: NewRelic agent container image tag
            displayName: Image Tag
            path: image.tag
          - description: Image pull policy stating whether or not to pull from the local image store
            displayName: Pull Policy
            path: image.pullPolicy
          - description: Zone Name given to this environment for NewRelic
            displayName: Zone Name
            path: newrelic.zone
            x-descriptors:
              - 'urn:alm:descriptor:io.kubernetes:core:v1:ConfigMap'
          - description: Port that the leader elector will listen on
            displayName: Leader Elector Port
            path: newrelic.leaderElectorPort
            x-descriptors:
              - 'urn:alm:descriptor:io.kubernetes:core:v1:ConfigMap'
          - description: NewRelic agent key
            displayName: Agent Key
            path: newrelic.agent.key
            x-descriptors:
              - 'urn:alm:descriptor:io.kubernetes:core:v1:Secret'
          - description: Name to use for NewRelic agent k8s resources
            displayName: K8s Name
            path: newrelic.agent.name
          - description: Endpoint hostname that NewRelic agent will connect to
            displayName: Endpoint Hostname
            path: newrelic.agent.endpoint.host
            x-descriptors:
              - 'urn:alm:descriptor:io.kubernetes:core:v1:ConfigMap'
          - description:  Endpoint Port that NewRelic agent will connect to
            displayName: Endpoint Port
            path: newrelic.agent.endpoint.port
            x-descriptors:
              - 'urn:alm:descriptor:io.kubernetes:core:v1:ConfigMap'
          - description:  Annotations to be added to pods
            displayName: Pod Annotations
            path: podAnnotations
            x-descriptors:
              - 'urn:alm:descriptor:io.kubernetes:core:v1:Pod'
          - description: Service account name used to deploy NewRelic agent pods
            displayName: Service Account Name
            path: serviceAccount
          - description: Tolerations for pod assignment
            displayName: Tolerations
            path: tolerations
          - description: Define resources requests and limits for individual Pods
            displayName: Compute Resources
            path: computeResources
            x-descriptors:
              - 'urn:alm:descriptor:com.tectonic.ui:resourceRequirements'
        statusDescriptors:
          - description: Current deployed state
            displayName: Conditions
            path: conditions
            x-descriptors:
              - 'urn:alm:descriptor:io.kubernetes.conditions'
        version: v1alpha1
  description: |
    This is an Operator for NewRelic, developed using the NewRelic helm chart available at [Newrelic's GitHub](https://github.com/helm/charts/tree/master/stable/newrelic-infrastructure).
    
    The operator will deploy the NewRelic agent (using the helm chart) on your Kubernetes or OpenShift cluster as a Daemonset.

    ## Prerequisites
    The NewRelic Operator will (by default) deploy the latest version of Instana from the Red Hat Container Catalog.
    The image will pull from the [Red Hat Container Catalog](https://access.redhat.com/containers), which will require the following:

    * RHN account (https://access.redhat.com)
    * RHCC Image pull secret in your project/namespace or [Red Hat Container Registry Authentication](https://access.redhat.com/RegistryAuthentication) setup on your OpenShift cluster

    To create an `rhcc` secret using docker (requires root/sudo or you must be in the docker group):
    ```
    # docker login -u <username> registry.connect.redhat.com
    Password:
    Login Succeeded
    # oc create secret generic rhcc --from-file=.dockerconfigjson=$HOME/.docker/config.json --type=kubernetes.io/dockerconfigjson
    ```

    To create an `rhcc` secret using podman:
    ```
    $ podman login -u <username> registry.connect.redhat.com
    Password:
    Login Succeeded!
    $ oc create secret generic rhcc --from-file=.dockerconfigjson=$XDG_RUNTIME_DIR/containers/auth.json --type=kubernetes.io/dockerconfigjson
    ```

    To link the `rhcc` secret to the `default` service account to use as an image pull secret in the current project/namespace:
    ```
    $ oc secrets link default rhcc --for=pull
    ```

    ## Required Parameters

    There is only one required parameter, and that is the Agent Key available by logging into [NewRelic](https://infrastructure.newrelic.com).

    Note that the Agent Key is kept in a base64-encoded K8s Secret, however the key is also visible as plain text within the Custom Resource spec.

    Values listed below are relative to the `spec:` field in the Custom Resource.

    * **newrelic.agent.key** - Your NewRelic Agent Key

    ## Advanced Tunables

    This is a list of all supported (but optional) parameters that can be passed to the Operator via the Custom Resource:

    Values are relative to the `spec:` field in the Custom Resource.

    * **image.name** - The full path to the NewRelic container image (defaults to `registry.connect.redhat.com/newrelic-openshift/newrelic-infrastructure-k8s-1`)
    * **image.tag** - The container image tag (defaults to `:latest`)
    * **image.pullPolicy** - The pullPolicy to use when pulling the image (defaults to `IfNotPresent`)
    * **newrelic.agent.name** - Name to use for the K8s resources created by the Operator (defaults to `newrelic-agent`)
    * **newrelic.agent.endpoint.host** - The hostname of the endpoint that the agent will connect to  (defaults to `saas-us-west-2.newrelic.com`)
    * **newrelic.agent.endpoint.port** - The TCP port that the agent will connect on
    * **podAnnotations** - Annotations to be added to pods (defaults to an empty key/value dictionary)
    * **serviceAccount** - The name of the service account used to deploy NewRelic (NOTE: This **must** match what is defined in the ClusterServiceVersion under `clusterpermissions:`)
    * **tolerations** - Tolerations for pod assignment (defaults to an empty list/array)
    * **computeResources** - Pod resource limits (defaults are `requests.cpu: 0.5`, `requests.memory: 512`, `limits.cpu: 1.5 ` and `limits.memory: 512`)
  displayName: NewRelic Operator
  icon:
    - base64data: 
      mediatype: "image/png"
  install:
    spec:
      deployments:
      permissions:
        - rules:
          - apiGroups:
            - ""
            resources:
            - pods
            - services
            - endpoints
            - persistentvolumeclaims
            - events
            - configmaps
            - secrets
            verbs:
            - '*'
          - apiGroups:
            - ""
            resources:
            - namespaces
            verbs:
            - get
          - apiGroups:
            - apps
            resources:
            - deployments
            - daemonsets
            - replicasets
            - statefulsets
            verbs:
            - '*'
          - apiGroups:
            - monitoring.coreos.com
            resources:
            - servicemonitors
            verbs:
            - get
            - create
          - apiGroups:
            - apps
            resourceNames:
            - newrelic-operator
            resources:
            - deployments/finalizers
            verbs:
            - update
          - apiGroups:
            - apm.newrelic.com
            resources:
            - '*'
            verbs:
            - '*'
          serviceAccountName: newrelic-operator
      # Required cluster permissions for the newrelic-agent service account
      # Also includes SCCs required to run on OpenShift
      clusterPermissions:
        - rules:
          - verbs:
              - use
            apiGroups:
              - security.openshift.io
            resources:
              - securitycontextconstraints
            resourceNames:
              - privileged
              - hostaccess
              - hostnetwork
          - nonResourceURLs:
              - /version
              - /healthz
            verbs: 
              - get
          - apiGroups:
              - batch
            resources:
              - jobs
            verbs:
              - get
              - list
              - watch
          - apiGroups: 
              - apps
            resources:
              - deployments
              - replicasets
              - ingresses
            verbs:
              - get
              - list
              - watch
          - apiGroups:
              - ""
            resources:
              - namespaces
              - events
              - services
              - endpoints
              - nodes
              - pods
              - replicationcontrollers
              - componentstatuses
              - resourcequotas
            verbs:
              - get
              - list
              - watch
          - apiGroups:
              - ""
            resources:
              - endpoints
            verbs:
              - create
              - update
              - patch
          serviceAccountName: newrelic-agent
    strategy: deployment
  installModes:
    - supported: true
      type: OwnNamespace
    - supported: true
      type: SingleNamespace
    - supported: false
      type: MultiNamespace
    - supported: false
      type: AllNamespaces
  keywords:
    - monitoring
    - apm
  links:
    - name: NewRelic Operator - RHC4TP GitHub
      url: https://github.com/RHC4TP/operators/tree/master/partners/newrelic-operator
    - name: NewRelic Documentation
      url: https://docs.newrelic.com
  maintainers:
    - email: connect@redhat.com
      name: Red Hat Partner Connect
  maturity: alpha
  provider:
    name: Red Hat Partner Connect
  version: 0.0.3
